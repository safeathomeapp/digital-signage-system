<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .file-info {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 0.5rem;
            display: none;
        }
        .day-checkbox {
            margin-right: 0.5rem;
        }
        .schedule-section {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .upload-panel {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            height: fit-content;
            position: sticky;
            top: 1rem;
        }
        .library-panel {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            min-height: 600px;
        }
        /* NEW MEDIA GRID LAYOUT */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
        }
        .media-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            position: relative;
        }
        .media-item:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .media-thumbnail {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #dee2e6;
            transition: all 0.2s;
        }
        .media-thumbnail:hover {
            border-color: #0d6efd;
            transform: scale(1.05);
        }
        .thumbnail-placeholder {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5em;
            border: 2px solid #dee2e6;
            transition: all 0.2s;
        }
        .thumbnail-placeholder:hover {
            border-color: #0d6efd;
            transform: scale(1.05);
        }
        .media-content {
            margin-top: 0.75rem;
            width: 100%;
        }
        .media-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.2;
            height: 2.4em;
        }
        .media-meta {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }
        .media-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .media-actions .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            z-index: 2;
        }
        .status-badge.status-active {
            background-color: #28a745;
        }
        .status-badge.status-expired {
            background-color: #dc3545;
        }
        .status-badge.status-paused {
            background-color: #ffc107;
            color: #212529;
        }
        .status-badge.status-scheduled {
            background-color: #17a2b8;
        }
        .assignment-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: #0d6efd;
            color: white;
            border-radius: 1rem;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 2;
        }
        .assignment-badge:empty {
            display: none;
        }
        /* Days and Duration Row */
        .days-duration-row {
            display: flex;
            align-items: end;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .days-section {
            flex: 1;
        }
        .duration-section {
            flex: 0 0 auto;
            min-width: 120px;
        }
        .date-controls-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .device-assignment-section {
            display: flex;
            gap: 1rem;
        }
        .device-column {
            flex: 1;
        }
        .device-checkboxes {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
        }
        .form-check-sm {
            font-size: 0.875rem;
        }
        .form-check-sm .form-check-input {
            width: 0.9em;
            height: 0.9em;
        }
        @media (max-width: 768px) {
            .days-duration-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .date-controls-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .device-assignment-section {
                flex-direction: column;
                gap: 0.5rem;
            }
            .upload-panel {
                position: static;
            }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tv me-2"></i>Digital Signage Manager
            </span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="/">Upload Content</a>
                <a class="nav-link text-white" href="/devices">Devices</a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Panel - Upload & Scheduling -->
            <div class="col-md-4">
                <div class="upload-panel p-4">
                    <h5 class="mb-3">
                        <i class="fas fa-upload me-2"></i>Upload & Schedule Content
                    </h5>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- File Selection -->
                        <div class="mb-3">
                            <label for="file" class="form-label">Select Media File</label>
                            <input type="file" class="form-control" id="file" name="file" 
                                   accept=".png,.jpg,.jpeg,.gif,.mp4,.mov,.avi,.webm,.mkv" required>
                            <div class="form-text">Images: PNG, JPG, GIF | Videos: MP4, MOV, AVI</div>
                            
                            <!-- File Info Display -->
                            <div id="fileInfo" class="file-info">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>File:</strong> <span id="fileName"></span><br>
                                        <strong>Size:</strong> <span id="fileSize"></span><br>
                                        <strong>Type:</strong> <span id="fileType"></span>
                                    </div>
                                    <div class="col-6" id="videoInfo" style="display: none;">
                                        <strong>Duration:</strong> <span id="videoDuration"></span><br>
                                        <strong>Resolution:</strong> <span id="videoResolution"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Days and Duration Row -->
                        <div class="days-duration-row">
                            <div class="days-section">
                                <label class="form-label small">Days to Show:</label>
                                <div class="d-flex flex-wrap">
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="dayMon" value="mon" checked>
                                        <label class="form-check-label" for="dayMon">Mon</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="dayTue" value="tue" checked>
                                        <label class="form-check-label" for="dayTue">Tue</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="dayWed" value="wed" checked>
                                        <label class="form-check-label" for="dayWed">Wed</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="dayThu" value="thu" checked>
                                        <label class="form-check-label" for="dayThu">Thu</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="dayFri" value="fri" checked>
                                        <label class="form-check-label" for="dayFri">Fri</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="daySat" value="sat" checked>
                                        <label class="form-check-label" for="daySat">Sat</label>
                                    </div>
                                    <div class="form-check form-check-sm day-checkbox">
                                        <input class="form-check-input" type="checkbox" id="daySun" value="sun" checked>
                                        <label class="form-check-label" for="daySun">Sun</label>
                                    </div>
                                </div>
                            </div>
                            <div class="duration-section">
                                <label class="form-label small">Display Duration:</label>
                                <select id="displayDuration" class="form-select form-select-sm">
                                    <option value="10" selected>10 sec</option>
                                    <option value="15">15 sec</option>
                                    <option value="20">20 sec</option>
                                    <option value="25">25 sec</option>
                                    <option value="30">30 sec</option>
                                    <option value="35">35 sec</option>
                                    <option value="40">40 sec</option>
                                    <option value="45">45 sec</option>
                                    <option value="50">50 sec</option>
                                    <option value="55">55 sec</option>
                                    <option value="60">60 sec</option>
                                </select>
                                <div id="videoMinDuration" style="display: none;">
                                    <small class="text-muted">Min: <span id="videoLength"></span></small>
                                </div>
                            </div>
                        </div>

                        <!-- Time Range -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label small">Start Time:</label>
                                <select id="startTime" class="form-select form-select-sm">
                                    <option value="">Any time</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">End Time:</label>
                                <select id="endTime" class="form-select form-select-sm">
                                    <option value="">Any time</option>
                                </select>
                            </div>
                        </div>

                        <!-- Date Controls Row -->
                        <div class="date-controls-row">
                            <div style="flex: 1;">
                                <label class="form-label small">Start Date:</label>
                                <input type="date" id="startDate" class="form-control form-control-sm">
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label small">Duration:</label>
                                <select class="form-select form-select-sm" id="dateRange" onchange="calculateEndDate()">
                                    <option value="">No end</option>
                                    <option value="1">1 month</option>
                                    <option value="2">2 months</option>
                                    <option value="3">3 months</option>
                                    <option value="6">6 months</option>
                                    <option value="12">1 year</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label small">End Date:</label>
                                <input type="date" id="endDate" class="form-control form-control-sm" readonly>
                            </div>
                        </div>

                        <!-- Device Assignment -->
                        <div class="mb-3">
                            <label class="form-label">Assign to Device:</label>
                            <div class="device-assignment-section">
                                <div class="device-column">
                                    <div class="form-check form-check-sm mb-2">
                                        <input class="form-check-input" type="checkbox" id="libraryOnly" value="library" checked>
                                        <label class="form-check-label" for="libraryOnly">Library only</label>
                                    </div>
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input" type="checkbox" id="allDevices" value="all" onchange="handleAllDevicesChange()">
                                        <label class="form-check-label" for="allDevices">All devices</label>
                                    </div>
                                </div>
                                <div class="device-column">
                                    <div id="deviceCheckboxes" class="device-checkboxes">
                                        <div class="text-muted small">Loading devices...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text small">Select assignment options</div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-upload me-2"></i>Upload Content
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Panel - Media Library -->
            <div class="col-md-8">
                <div class="library-panel p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-photo-video me-2"></i>Media Library
                        </h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadMediaList()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div id="mediaList">
                        <div class="text-center">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">Loading media...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Media Modal -->
    <div class="modal fade" id="editMediaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Media Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editMediaForm">
                        <input type="hidden" id="editMediaId">
                        
                        <!-- Days of Week -->
                        <div class="mb-3">
                            <label class="form-label">Days to Show:</label>
                            <div class="d-flex flex-wrap">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDayMon" value="mon">
                                    <label class="form-check-label small" for="editDayMon">Mon</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDayTue" value="tue">
                                    <label class="form-check-label small" for="editDayTue">Tue</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDayWed" value="wed">
                                    <label class="form-check-label small" for="editDayWed">Wed</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDayThu" value="thu">
                                    <label class="form-check-label small" for="editDayThu">Thu</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDayFri" value="fri">
                                    <label class="form-check-label small" for="editDayFri">Fri</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDaySat" value="sat">
                                    <label class="form-check-label small" for="editDaySat">Sat</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="editDaySun" value="sun">
                                    <label class="form-check-label small" for="editDaySun">Sun</label>
                                </div>
                            </div>
                        </div>

                        <!-- Display Duration -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Display Duration:</label>
                                <select id="editDisplayDuration" class="form-select">
                                    <option value="10">10 sec</option>
                                    <option value="15">15 sec</option>
                                    <option value="20">20 sec</option>
                                    <option value="25">25 sec</option>
                                    <option value="30">30 sec</option>
                                    <option value="35">35 sec</option>
                                    <option value="40">40 sec</option>
                                    <option value="45">45 sec</option>
                                    <option value="50">50 sec</option>
                                    <option value="55">55 sec</option>
                                    <option value="60">60 sec</option>
                                </select>
                            </div>
                        </div>

                        <!-- Time Range -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Time:</label>
                                <select id="editStartTime" class="form-select">
                                    <option value="">Any time</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Time:</label>
                                <select id="editEndTime" class="form-select">
                                    <option value="">Any time</option>
                                </select>
                            </div>
                        </div>

                        <!-- Date Range -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Date:</label>
                                <input type="date" id="editStartDate" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Date:</label>
                                <input type="date" id="editEndDate" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMediaEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Assignment Modal -->
    <div class="modal fade" id="deviceAssignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign to Devices</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignMediaId">
                    <div class="mb-3">
                        <label class="form-label">Select Device:</label>
                        <select id="assignDeviceSelect" class="form-select">
                            <option value="">Choose a device...</option>
                            <option value="all">All devices</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Display Duration:</label>
                        <select id="assignDuration" class="form-select">
                            <option value="10" selected>10 sec</option>
                            <option value="15">15 sec</option>
                            <option value="20">20 sec</option>
                            <option value="25">25 sec</option>
                            <option value="30">30 sec</option>
                            <option value="35">35 sec</option>
                            <option value="40">40 sec</option>
                            <option value="45">45 sec</option>
                            <option value="50">50 sec</option>
                            <option value="55">55 sec</option>
                            <option value="60">60 sec</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignToDevice()">Assign Content</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideoElement = null;
        let currentDevices = [];

        // Set default start date to today
        document.getElementById('startDate').valueAsDate = new Date();

        // Initialize time selectors and load devices
        initializeTimeSelectors();
        loadDevicesForAssignment();

        // Initialize time selectors with 15-minute increments
        function initializeTimeSelectors() {
            const timeSelectors = ['startTime', 'endTime', 'editStartTime', 'editEndTime'];
            
            timeSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector && selector.options.length <= 1) {
                    for (let hour = 0; hour < 24; hour++) {
                        for (let min = 0; min < 60; min += 15) {
                            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                            const displayStr = `${hour === 0 ? 12 : hour > 12 ? hour - 12 : hour}:${min.toString().padStart(2, '0')} ${hour < 12 ? 'AM' : 'PM'}`;
                            const option = document.createElement('option');
                            option.value = timeStr;
                            option.textContent = displayStr;
                            selector.appendChild(option);
                        }
                    }
                }
            });
        }

        // Handle "All Devices" checkbox behavior
        function handleAllDevicesChange() {
            const allDevicesCheckbox = document.getElementById('allDevices');
            const libraryOnlyCheckbox = document.getElementById('libraryOnly');
            const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]');
            
            if (allDevicesCheckbox.checked) {
                libraryOnlyCheckbox.checked = false;
                deviceCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                deviceCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                libraryOnlyCheckbox.checked = true;
            }
        }

        // Handle individual device checkbox changes
        function handleDeviceCheckboxChange() {
            const allDevicesCheckbox = document.getElementById('allDevices');
            const libraryOnlyCheckbox = document.getElementById('libraryOnly');
            const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]');
            const checkedDevices = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked');
            
            if (checkedDevices.length > 0) {
                libraryOnlyCheckbox.checked = false;
            } else {
                libraryOnlyCheckbox.checked = true;
            }
            
            if (checkedDevices.length === deviceCheckboxes.length && deviceCheckboxes.length > 0) {
                allDevicesCheckbox.checked = true;
            } else {
                allDevicesCheckbox.checked = false;
            }
        }

        // File input handler
        document.getElementById('file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                displayFileInfo(file);
            } else {
                document.getElementById('fileInfo').style.display = 'none';
            }
        });

        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileType = document.getElementById('fileType');
            const videoInfo = document.getElementById('videoInfo');
            const videoMinDuration = document.getElementById('videoMinDuration');

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            const isVideo = file.type.startsWith('video/');
            fileType.textContent = isVideo ? 'Video' : 'Image';

            if (isVideo) {
                videoInfo.style.display = 'block';
                videoMinDuration.style.display = 'block';
                loadVideoMetadata(file);
            } else {
                videoInfo.style.display = 'none';
                videoMinDuration.style.display = 'none';
                document.getElementById('displayDuration').value = '10';
            }

            fileInfo.style.display = 'block';
        }

        function loadVideoMetadata(file) {
            if (currentVideoElement) {
                currentVideoElement.remove();
            }

            currentVideoElement = document.createElement('video');
            currentVideoElement.preload = 'metadata';
            
            currentVideoElement.onloadedmetadata = function() {
                const duration = Math.ceil(currentVideoElement.duration);
                const resolution = `${currentVideoElement.videoWidth}x${currentVideoElement.videoHeight}`;
                
                document.getElementById('videoDuration').textContent = formatDuration(duration);
                document.getElementById('videoResolution').textContent = resolution;
                document.getElementById('videoLength').textContent = `${duration}s`;
                
                const durationSelect = document.getElementById('displayDuration');
                const options = durationSelect.options;
                for (let i = 0; i < options.length; i++) {
                    const value = parseInt(options[i].value);
                    if (value < duration) {
                        options[i].disabled = true;
                        options[i].textContent += ' (too short)';
                    } else {
                        options[i].disabled = false;
                        options[i].textContent = options[i].textContent.replace(' (too short)', '');
                    }
                }
                
                if (parseInt(durationSelect.value) < duration) {
                    for (let i = 0; i < options.length; i++) {
                        if (parseInt(options[i].value) >= duration) {
                            durationSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            };

            currentVideoElement.src = URL.createObjectURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateEndDate() {
            const startDate = document.getElementById('startDate').value;
            const rangeValue = document.getElementById('dateRange').value;
            const endDateInput = document.getElementById('endDate');
            
            if (rangeValue === 'custom') {
                endDateInput.readOnly = false;
                endDateInput.style.backgroundColor = '';
                return;
            }
            
            endDateInput.readOnly = true;
            endDateInput.style.backgroundColor = '#f8f9fa';
            
            if (startDate && rangeValue && rangeValue !== 'custom') {
                const start = new Date(startDate);
                const end = new Date(start.getFullYear(), start.getMonth() + parseInt(rangeValue), start.getDate());
                endDateInput.value = end.toISOString().split('T')[0];
            } else {
                endDateInput.value = '';
            }
        }

        async function loadDevicesForAssignment() {
            try {
                const response = await fetch('/api/devices');
                currentDevices = await response.json();
                
                const assignDeviceSelect = document.getElementById('assignDeviceSelect');
                if (assignDeviceSelect) {
                    currentDevices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.device_id;
                        option.textContent = device.display_name;
                        assignDeviceSelect.appendChild(option);
                    });
                }
                
                updateDeviceCheckboxes();
                
            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('deviceCheckboxes').innerHTML = '<div class="text-danger small">Error loading devices</div>';
            }
        }

        function updateDeviceCheckboxes() {
            const container = document.getElementById('deviceCheckboxes');
            
            if (currentDevices.length === 0) {
                container.innerHTML = '<div class="text-muted small">No devices found</div>';
                return;
            }
            
            let html = '';
            currentDevices.forEach(device => {
                const deviceName = device.display_name || device.device_name;
                html += `
                    <div class="form-check form-check-sm mb-1">
                        <input class="form-check-input device-checkbox" type="checkbox" 
                               id="device_${device.device_id}" value="${device.device_id}"
                               onchange="handleDeviceCheckboxChange()">
                        <label class="form-check-label" for="device_${device.device_id}">
                            ${deviceName}
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getMediaStatus(media) {
            const now = new Date();
            const startDate = media.start_date ? new Date(media.start_date) : null;
            const endDate = media.end_date ? new Date(media.end_date) : null;
            
            if (!media.is_active) {
                return { status: 'paused', icon: 'fas fa-pause-circle', class: 'status-paused', text: 'Paused' };
            }
            
            if (endDate && now > endDate) {
                return { status: 'expired', icon: 'fas fa-times-circle', class: 'status-expired', text: 'Expired' };
            }
            
            if (startDate && now < startDate) {
                return { status: 'scheduled', icon: 'fas fa-clock', class: 'status-scheduled', text: 'Scheduled' };
            }
            
            return { status: 'active', icon: 'fas fa-play-circle', class: 'status-active', text: 'Active' };
        }

        function createThumbnail(media) {
            if (media.file_type === 'image') {
                return `<img src="/uploads/${media.filename}" class="media-thumbnail" alt="${media.original_name}">`;
            } else {
                return `<div class="thumbnail-placeholder"><i class="fas fa-video"></i></div>`;
            }
        }

        function getStatusIcon(media) {
            const status = getMediaStatus(media);
            switch(status.status) {
                case 'active': return '<i class="fas fa-play" title="Active"></i>';
                case 'paused': return '<i class="fas fa-pause" title="Paused"></i>';
                case 'expired': return '<i class="fas fa-times" title="Expired"></i>';
                case 'scheduled': return '<i class="fas fa-clock" title="Scheduled"></i>';
                default: return '<i class="fas fa-play" title="Active"></i>';
            }
        }

        async function toggleMediaStatus(mediaId, currentStatus) {
            try {
                const response = await fetch(`/api/media/${mediaId}/toggle`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                
                if (response.ok) {
                    loadMediaList();
                } else {
                    alert('Failed to update media status');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteMedia(mediaId, filename) {
            if (!confirm(`Delete "${filename}"? This will remove it from all devices and cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/media/${mediaId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    loadMediaList();
                } else {
                    alert('Failed to delete media');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function editMedia(mediaId) {
            document.getElementById('editMediaId').value = mediaId;
            new bootstrap.Modal(document.getElementById('editMediaModal')).show();
        }

        async function saveMediaEdit() {
            const mediaId = document.getElementById('editMediaId').value;
            
            const selectedDays = [];
            document.querySelectorAll('input[type="checkbox"][id^="editDay"]:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });
            
            const daysToUse = selectedDays.length > 0 ? selectedDays : ['all'];
            
            const startTime = document.getElementById('editStartTime').value || null;
            const endTime = document.getElementById('editEndTime').value || null;
            
            const updateData = {
                days_of_week: daysToUse,
                display_duration: parseInt(document.getElementById('editDisplayDuration').value),
                start_time: startTime,
                end_time: endTime,
                start_date: document.getElementById('editStartDate').value || null,
                end_date: document.getElementById('editEndDate').value || null
            };
            
            try {
                const response = await fetch(`/api/media/${mediaId}/schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editMediaModal')).hide();
                    loadMediaList();
                } else {
                    alert('Failed to save changes');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showDeviceAssignment(mediaId) {
            document.getElementById('assignMediaId').value = mediaId;
            new bootstrap.Modal(document.getElementById('deviceAssignModal')).show();
        }

        async function assignToDevice() {
            const mediaId = document.getElementById('assignMediaId').value;
            const deviceId = document.getElementById('assignDeviceSelect').value;
            const duration = document.getElementById('assignDuration').value;
            
            if (!deviceId) {
                alert('Please select a device');
                return;
            }
            
            try {
                let response;
                if (deviceId === 'all') {
                    response = await fetch('/api/assign-all-devices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            media_id: parseInt(mediaId),
                            display_duration: parseInt(duration)
                        })
                    });
                } else {
                    response = await fetch('/api/assign-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            device_id: deviceId,
                            media_id: parseInt(mediaId),
                            display_duration: parseInt(duration)
                        })
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('deviceAssignModal')).hide();
                    loadMediaList();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Assignment failed: ' + error.message);
            }
        }

        // Upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }

            formData.append('file', file);
            
            const selectedDays = [];
            document.querySelectorAll('input[type="checkbox"][id^="day"]:checked').forEach(cb => {
                selectedDays.push(cb.value);
            });
            
            const daysToUse = selectedDays.length > 0 ? selectedDays : ['all'];
            
            let videoDuration = null;
            if (currentVideoElement && currentVideoElement.duration) {
                videoDuration = Math.ceil(currentVideoElement.duration);
            }
            
            let deviceAssignment = null;
            const libraryOnly = document.getElementById('libraryOnly').checked;
            const allDevices = document.getElementById('allDevices').checked;
            
            if (!libraryOnly) {
                if (allDevices) {
                    deviceAssignment = 'all';
                } else {
                    const selectedDevices = [];
                    document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                        selectedDevices.push(cb.value);
                    });
                    
                    if (selectedDevices.length > 0) {
                        deviceAssignment = selectedDevices[0];
                    }
                }
            }
            
            const startTime = document.getElementById('startTime').value || null;
            const endTime = document.getElementById('endTime').value || null;
            
            const schedulingData = {
                days_of_week: daysToUse,
                display_duration: parseInt(document.getElementById('displayDuration').value),
                video_duration: videoDuration,
                start_time: startTime,
                end_time: endTime,
                start_date: document.getElementById('startDate').value || null,
                end_date: document.getElementById('endDate').value || null,
                device_assignment: deviceAssignment
            };
            
            formData.append('scheduling', JSON.stringify(schedulingData));
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Content uploaded successfully!');
                    this.reset();
                    document.getElementById('fileInfo').style.display = 'none';
                    document.getElementById('startDate').valueAsDate = new Date();
                    
                    document.getElementById('libraryOnly').checked = true;
                    document.getElementById('allDevices').checked = false;
                    document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    
                    document.querySelectorAll('input[type="checkbox"][id^="day"]').forEach(cb => {
                        cb.checked = true;
                    });
                    
                    loadMediaList();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        });

        // Load media library with thumbnail grid
        async function loadMediaList() {
            try {
                const response = await fetch('/api/media/detailed');
                const mediaList = await response.json();
                const container = document.getElementById('mediaList');
                
                if (mediaList.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No media uploaded yet.</p>';
                    return;
                }
                
                let html = '<div class="media-grid">';
                
                mediaList.forEach(media => {
                    const status = getMediaStatus(media);
                    const fileSize = Math.round(media.file_size / 1024) + ' KB';
                    const thumbnail = createThumbnail(media);
                    const statusIcon = getStatusIcon(media);
                    
                    html += `
                        <div class="media-item">
                            <!-- Status Badge -->
                            <div class="status-badge ${status.class}">
                                ${statusIcon}
                            </div>
                            
                            <!-- Assignment Count Badge -->
                            <div class="assignment-badge">${media.assignment_count > 0 ? media.assignment_count : ''}</div>
                            
                            <!-- Thumbnail -->
                            ${thumbnail}
                            
                            <!-- Media Content -->
                            <div class="media-content">
                                <div class="media-title">${media.original_name}</div>
                                <div class="media-meta">
                                    ${media.file_type}  ${fileSize}
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="media-actions">
                                    <button class="btn btn-info btn-sm" onclick="showDeviceAssignment(${media.id})" title="Assign to devices">
                                        <i class="fas fa-tv"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="editMedia(${media.id})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMedia(${media.id}, '${media.original_name}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" ${media.is_active ? 'checked' : ''} 
                                               onchange="toggleMediaStatus(${media.id}, ${media.is_active})" title="Active/Inactive">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading media list:', error);
                document.getElementById('mediaList').innerHTML = '<p class="text-danger">Error loading media library.</p>';
            }
        }

        // Load media library on page load
        loadMediaList();
    </script>
</body>
</html>