<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management - Digital Signage Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Panel Styles */
        .library-panel, .device-panel {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            min-height: 700px;
        }

        /* Media Grid Layout for Library */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
            max-height: 600px;
            overflow-y: auto;
        }

        .media-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 0.75rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            position: relative;
            cursor: grab;
            border: 2px solid transparent;
        }

        .media-item:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: #0d6efd;
        }

        .media-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .media-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #dee2e6;
        }

        .thumbnail-placeholder {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            border: 2px solid #dee2e6;
        }

        .media-content {
            margin-top: 0.5rem;
            width: 100%;
        }

        .media-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.1;
            height: 1.8em;
        }

        .media-meta {
            font-size: 0.65rem;
            color: #6c757d;
        }

        /* Device Content List */
        .device-content {
            max-height: 550px;
            overflow-y: auto;
        }

        .device-content-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: move;
        }

        .device-content-item:hover {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-color: #0d6efd;
        }

        .device-content-item.drag-over {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        .device-content-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .device-thumbnail-placeholder {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .device-content-info {
            flex: 1;
            min-width: 0;
        }

        .device-content-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .device-content-details {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .detail-badge {
            display: inline-block;
            margin: 0.125rem 0.25rem 0.125rem 0;
            padding: 0.125rem 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            font-size: 0.65rem;
        }

        .device-content-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .drag-handle {
            cursor: move;
            color: #6c757d;
            margin-right: 0.5rem;
        }

        .drag-handle:hover {
            color: #495057;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            color: #6c757d;
            margin: 1rem 0;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #28a745;
            background-color: #f8fff9;
            color: #28a745;
        }

        /* Device Selector */
        .device-selector {
            position: sticky;
            top: 1rem;
            z-index: 10;
        }

        /* Play Order Indicator */
        .play-order {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 0.5rem;
            }
            
            .media-thumbnail, .thumbnail-placeholder {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tv me-2"></i>Device Management
            </span>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="/">Upload Content</a>
                <a class="nav-link text-white" href="/devices">Devices</a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Panel - Media Library -->
            <div class="col-md-5">
                <div class="library-panel p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-photo-video me-2"></i>Media Library
                        </h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadMediaLibrary()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div id="mediaLibrary">
                        <div class="text-center">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">Loading media...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Device Content -->
            <div class="col-md-7">
                <div class="device-panel p-4">
                    <!-- Device Selector -->
                    <div class="device-selector bg-white p-3 rounded mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-desktop me-2"></i>Device Content
                            </h5>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <select id="deviceSelector" class="form-select" onchange="loadDeviceContent()">
                                    <option value="">Select a device...</option>
                                </select>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-info btn-sm" onclick="showDeviceSettings()" title="Device Settings">
                                    <i class="fas fa-cog me-1"></i>Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Device Content Area -->
                    <div id="deviceContentArea">
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-tv fa-3x mb-3"></i>
                            <h6>Select a device to manage content</h6>
                            <p class="mb-0">Choose a device from the dropdown above to view and manage its content</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Settings Modal -->
    <div class="modal fade" id="deviceSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Device Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceSettingsForm">
                        <input type="hidden" id="settingsDeviceId">
                        
                        <div class="mb-3">
                            <label class="form-label">Device Name:</label>
                            <input type="text" id="deviceCustomName" class="form-control" placeholder="Enter custom device name">
                            <div class="form-text">Original ID: <span id="deviceOriginalId"></span></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Location:</label>
                            <input type="text" id="deviceLocation" class="form-control" placeholder="Enter device location">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Device Info:</label>
                            <div class="small text-muted">
                                <div>Last Check-in: <span id="deviceLastCheckin"></span></div>
                                <div>IP Address: <span id="deviceIpAddress"></span></div>
                                <div>Content Count: <span id="deviceContentCount"></span></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDeviceSettings()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Details Modal -->
    <div class="modal fade" id="contentDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Content Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="contentDetailsForm">
                        <input type="hidden" id="editAssignmentId">
                        
                        <div class="mb-3">
                            <label class="form-label">Display Duration:</label>
                            <select id="editContentDuration" class="form-select">
                                <option value="10">10 seconds</option>
                                <option value="15">15 seconds</option>
                                <option value="20">20 seconds</option>
                                <option value="25">25 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="35">35 seconds</option>
                                <option value="40">40 seconds</option>
                                <option value="45">45 seconds</option>
                                <option value="50">50 seconds</option>
                                <option value="55">55 seconds</option>
                                <option value="60">60 seconds</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="removeContent()">Remove from Device</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContentSettings()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('=== DRAG AND DROP DEBUG VERSION ===');
        console.log('Script loading...');

        let currentDevices = [];
        let currentDeviceId = null;
        let currentDeviceContent = [];
        let draggedElement = null;
        let draggedFromLibrary = false;

        // Error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript Error:', msg, 'at line', lineNo);
            return false;
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing...');
            loadDevices();
            loadMediaLibrary();
        });

        // Load devices for selector
        async function loadDevices() {
            console.log('Loading devices...');
            try {
                const response = await fetch('/api/devices');
                currentDevices = await response.json();
                console.log('Devices loaded:', currentDevices.length);
                
                const selector = document.getElementById('deviceSelector');
                selector.innerHTML = '<option value="">Select a device...</option>';
                
                currentDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.device_id;
                    option.textContent = device.display_name || device.device_name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        // Load media library and setup drag and drop
        async function loadMediaLibrary() {
            console.log('Loading media library...');
            try {
                const response = await fetch('/api/media/detailed');
                const mediaList = await response.json();
                const container = document.getElementById('mediaLibrary');
                console.log('Media API response:', mediaList.length, 'items');
                
                if (mediaList.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No media in library.</p>';
                    return;
                }
                
                let html = '<div class="media-grid">';
                
                mediaList.forEach(media => {
                    const thumbnail = createThumbnail(media);
                    const fileSize = Math.round(media.file_size / 1024) + ' KB';
                    
                    html += `
                        <div class="media-item" draggable="true" data-media-id="${media.id}" data-media-type="${media.file_type}">
                            ${thumbnail}
                            <div class="media-content">
                                <div class="media-title">${media.original_name}</div>
                                <div class="media-meta">${media.file_type} â€¢ ${fileSize}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                console.log('Media library HTML updated, setting up drag and drop...');
                
                // Use setTimeout to ensure DOM is updated before setting up drag events
                setTimeout(() => {
                    setupDragAndDrop();
                }, 100);
                
            } catch (error) {
                console.error('Error loading media library:', error);
                document.getElementById('mediaLibrary').innerHTML = '<p class="text-danger">Error loading media library.</p>';
            }
        }

        // Create thumbnail
        function createThumbnail(media) {
            if (media.file_type === 'image') {
                return `<img src="/uploads/${media.filename}" class="media-thumbnail" alt="${media.original_name}">`;
            } else {
                return `<div class="thumbnail-placeholder"><i class="fas fa-video"></i></div>`;
            }
        }

        // Load device content
        async function loadDeviceContent() {
            currentDeviceId = document.getElementById('deviceSelector').value;
            const contentArea = document.getElementById('deviceContentArea');
            
            console.log('Loading content for device:', currentDeviceId);
            
            if (!currentDeviceId) {
                contentArea.innerHTML = `
                    <div class="drop-zone" id="dropZone">
                        <i class="fas fa-tv fa-3x mb-3"></i>
                        <h6>Select a device to manage content</h6>
                        <p class="mb-0">Choose a device from the dropdown above to view and manage its content</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/device/${currentDeviceId}/content`);
                currentDeviceContent = await response.json();
                console.log('Device content loaded:', currentDeviceContent.length, 'items');
                
                renderDeviceContent();
                
            } catch (error) {
                console.error('Error loading device content:', error);
                contentArea.innerHTML = '<p class="text-danger">Error loading device content.</p>';
            }
        }

        // Render device content list
        function renderDeviceContent() {
            const contentArea = document.getElementById('deviceContentArea');
            
            if (currentDeviceContent.length === 0) {
                contentArea.innerHTML = `
                    <div class="drop-zone" id="dropZone">
                        <i class="fas fa-plus-circle fa-3x mb-3"></i>
                        <h6>No content assigned to this device</h6>
                        <p class="mb-0">Drag media files from the library to assign them to this device</p>
                    </div>
                `;
            } else {
                let html = '<div class="device-content" id="deviceContent">';
                
                currentDeviceContent.forEach((content, index) => {
                    const thumbnail = createDeviceThumbnail(content);
                    
                    html += `
                        <div class="device-content-item" draggable="true" data-assignment-id="${content.assignment_id}" data-index="${index}">
                            <div class="play-order">${index + 1}</div>
                            <div class="drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            ${thumbnail}
                            <div class="device-content-info">
                                <div class="device-content-title">${content.original_name}</div>
                                <div class="device-content-details">
                                    <span class="detail-badge"><i class="fas fa-clock"></i> ${content.display_duration}s</span>
                                    <span class="detail-badge"><i class="fas fa-file"></i> ${content.file_type}</span>
                                </div>
                            </div>
                            <div class="device-content-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="editContentSettings(${content.assignment_id}, ${content.display_duration})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add drop zone at bottom
                html += `
                    <div class="drop-zone mt-3" id="dropZone">
                        <i class="fas fa-plus-circle fa-2x mb-2"></i>
                        <p class="mb-0">Drag more media here to add to this device</p>
                    </div>
                `;
                
                contentArea.innerHTML = html;
            }
            
            setupDeviceContentDrag();
        }

        // Create device thumbnail
        function createDeviceThumbnail(content) {
            if (content.file_type === 'image') {
                return `<img src="/uploads/${content.filename}" class="device-content-thumbnail" alt="${content.original_name}">`;
            } else {
                return `<div class="device-thumbnail-placeholder"><i class="fas fa-video"></i></div>`;
            }
        }

        // FIXED: Setup drag and drop for media library
        function setupDragAndDrop() {
            console.log('Setting up drag and drop for media library');
            
            const mediaItems = document.querySelectorAll('.media-item');
            console.log('Found media items:', mediaItems.length);
            
            if (mediaItems.length === 0) {
                console.log('No media items found to setup drag and drop');
                return;
            }
            
            // Add event listeners to all media items
            mediaItems.forEach((item, index) => {
                console.log('Setting up drag for item', index, 'with media ID:', item.dataset.mediaId);
                
                // Dragstart event
                item.addEventListener('dragstart', function(e) {
                    console.log('Drag started from media item:', e.target.dataset.mediaId);
                    draggedElement = e.target;
                    draggedFromLibrary = true;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/plain', e.target.dataset.mediaId);
                });

                // Dragend event
                item.addEventListener('dragend', function(e) {
                    console.log('Drag ended');
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                    draggedFromLibrary = false;
                });
            });

            // Global drop zone handlers
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone && draggedFromLibrary) {
                    dropZone.classList.add('drag-over');
                    e.dataTransfer.dropEffect = 'copy';
                }
            });

            document.addEventListener('dragleave', function(e) {
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone && !dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', function(e) {
                e.preventDefault();
                console.log('Drop event triggered');
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                    if (draggedFromLibrary && currentDeviceId && draggedElement) {
                        const mediaId = draggedElement.dataset.mediaId || e.dataTransfer.getData('text/plain');
                        console.log('Dropping media ID:', mediaId, 'on device:', currentDeviceId);
                        console.log('Dragged element:', draggedElement);
                        console.log('Dragged element dataset:', draggedElement.dataset);
                        assignMediaToDevice(mediaId);
                    } else {
                        console.log('Drop failed - conditions not met:', {
                            draggedFromLibrary,
                            currentDeviceId,
                            draggedElement: !!draggedElement,
                            draggedElementData: draggedElement ? draggedElement.dataset : 'null'
                        });
                    }
                }
            });
            
            console.log('Drag and drop setup complete');
        }

        // Setup drag and drop for device content reordering
        function setupDeviceContentDrag() {
            const contentItems = document.querySelectorAll('.device-content-item');
            
            contentItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    if (!draggedFromLibrary) {
                        draggedElement = e.target;
                        e.target.style.opacity = '0.5';
                    }
                });

                item.addEventListener('dragend', function(e) {
                    if (!draggedFromLibrary) {
                        e.target.style.opacity = '1';
                        draggedElement = null;
                        
                        // Remove all drag-over classes
                        document.querySelectorAll('.device-content-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                    }
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (!draggedFromLibrary && draggedElement && draggedElement !== e.currentTarget) {
                        e.currentTarget.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', function(e) {
                    e.currentTarget.classList.remove('drag-over');
                });

                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over');
                    
                    if (!draggedFromLibrary && draggedElement && draggedElement !== e.currentTarget) {
                        const fromIndex = parseInt(draggedElement.dataset.index);
                        const toIndex = parseInt(e.currentTarget.dataset.index);
                        
                        reorderContent(fromIndex, toIndex);
                    }
                });
            });
        }

        // FIXED: Assign media to device function
        async function assignMediaToDevice(mediaId) {
            console.log('assignMediaToDevice called with mediaId:', mediaId);
            
            if (!currentDeviceId) {
                console.error('No device selected');
                alert('Please select a device first');
                return;
            }
            
            try {
                const requestData = {
                    device_id: currentDeviceId,
                    media_id: parseInt(mediaId),
                    display_duration: 10
                };
                console.log('Sending request data:', requestData);
                
                const response = await fetch('/api/assign-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);

                if (response.ok) {
                    console.log('Assignment successful, reloading content...');
                    await loadDeviceContent(); // Reload content
                } else {
                    console.error('Assignment failed:', result.error);
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Assignment error:', error);
                alert('Failed to assign content: ' + error.message);
            }
        }

        // Reorder content
        async function reorderContent(fromIndex, toIndex) {
            // Update local array
            const item = currentDeviceContent.splice(fromIndex, 1)[0];
            currentDeviceContent.splice(toIndex, 0, item);
            
            // Update play orders
            const updates = currentDeviceContent.map((content, index) => ({
                assignment_id: content.assignment_id,
                play_order: index + 1
            }));

            try {
                const response = await fetch('/api/device/reorder-content', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: currentDeviceId,
                        content_order: updates
                    })
                });

                if (response.ok) {
                    renderDeviceContent(); // Re-render with new order
                } else {
                    alert('Failed to reorder content');
                    loadDeviceContent(); // Reload original order
                }
            } catch (error) {
                console.error('Error reordering content:', error);
                loadDeviceContent(); // Reload original order
            }
        }

        // Show device settings modal
        function showDeviceSettings() {
            if (!currentDeviceId) {
                alert('Please select a device first');
                return;
            }

            const device = currentDevices.find(d => d.device_id === currentDeviceId);
            if (!device) return;

            document.getElementById('settingsDeviceId').value = device.device_id;
            document.getElementById('deviceCustomName').value = device.custom_name || '';
            document.getElementById('deviceLocation').value = device.location || '';
            document.getElementById('deviceOriginalId').textContent = device.device_id;
            document.getElementById('deviceLastCheckin').textContent = device.last_checkin ? 
                new Date(device.last_checkin).toLocaleString() : 'Never';
            document.getElementById('deviceIpAddress').textContent = device.ip_address || 'Unknown';
            document.getElementById('deviceContentCount').textContent = device.content_count || 0;

            new bootstrap.Modal(document.getElementById('deviceSettingsModal')).show();
        }

        // Save device settings
        async function saveDeviceSettings() {
            const deviceId = document.getElementById('settingsDeviceId').value;
            const customName = document.getElementById('deviceCustomName').value;
            const location = document.getElementById('deviceLocation').value;

            try {
                const response = await fetch(`/api/device/${deviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        custom_name: customName,
                        location: location
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('deviceSettingsModal')).hide();
                    loadDevices(); // Reload devices to update display names
                } else {
                    alert('Failed to save device settings');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Edit content settings
        function editContentSettings(assignmentId, currentDuration) {
            document.getElementById('editAssignmentId').value = assignmentId;
            document.getElementById('editContentDuration').value = currentDuration;
            new bootstrap.Modal(document.getElementById('contentDetailsModal')).show();
        }

        // Save content settings
        async function saveContentSettings() {
            const assignmentId = document.getElementById('editAssignmentId').value;
            const duration = document.getElementById('editContentDuration').value;

            try {
                const response = await fetch(`/api/device-content/${assignmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        display_duration: parseInt(duration)
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('contentDetailsModal')).hide();
                    loadDeviceContent(); // Reload content
                } else {
                    alert('Failed to save content settings');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Remove content from device
        async function removeContent() {
            const assignmentId = document.getElementById('editAssignmentId').value;
            
            if (!confirm('Remove this content from the device?')) {
                return;
            }

            try {
                const response = await fetch(`/api/remove-content/${assignmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('contentDetailsModal')).hide();
                    loadDeviceContent(); // Reload content
                } else {
                    alert('Failed to remove content');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>